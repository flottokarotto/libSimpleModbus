name: CI

on:
  push:
    branches: [master, main, 'feature/**']
  pull_request:
    branches: [master, main]

env:
  ALIRE_VERSION: 2.1.0

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Alire
        uses: alire-project/setup-alire@v3
        with:
          version: ${{ env.ALIRE_VERSION }}
          toolchain: gnat_native^15
          cache: true

      - name: Cache Alire
        uses: actions/cache@v4
        with:
          path: ~/.cache/alire
          key: alire-${{ runner.os }}-${{ hashFiles('alire.toml') }}

      - name: Build and test
        run: |
          alr toolchain --select gnat_native^15 gprbuild
          alr build
          alr exec -- gprbuild -P tests/aunit_tests.gpr -XAUNIT_RUNTIME=full -XCOVERAGE=enabled
          ./bin/test_runner

      - name: Coverage
        run: |
          sudo apt-get install -qq lcov
          GCOV=$(alr exec -- which gcov)
          lcov --capture --directory obj/tests --output-file coverage.info --gcov-tool "$GCOV"
          lcov --remove coverage.info '/usr/*' '*/aunit/*' -o coverage.info --ignore-errors unused

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.info
          fail_ci_if_error: false

      - name: Validate SunSpec & build examples
        run: |
          python3 tools/sunspec_codegen.py --validate 1 src/energy/ada_modbus-energy-sunspec-common.ads
          python3 tools/sunspec_codegen.py --validate 103 src/energy/ada_modbus-energy-sunspec-inverter.ads
          python3 tools/sunspec_codegen.py --validate 124 src/energy/ada_modbus-energy-sunspec-storage.ads
          python3 tools/sunspec_codegen.py --validate 203 src/energy/ada_modbus-energy-sunspec-meter.ads
          alr exec -- gprbuild -P examples/examples.gpr

  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Alire
        uses: alire-project/setup-alire@v3
        with:
          version: ${{ env.ALIRE_VERSION }}
          toolchain: gnat_native^15
          cache: true

      - name: Cache Alire
        uses: actions/cache@v4
        with:
          path: ~/.cache/alire
          key: alire-${{ runner.os }}-${{ hashFiles('alire.toml', 'tls/alire.toml') }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: tests/integration/requirements.txt

      - name: Setup
        run: |
          alr toolchain --select gnat_native^15 gprbuild
          pip install -r tests/integration/requirements.txt
          chmod +x tests/integration/certs/generate_test_certs.sh
          tests/integration/certs/generate_test_certs.sh
          cd tls && alr pin adamodbus --use=.. && alr build

      - name: Run Modbus TCP tests
        run: |
          nohup python3 tests/integration/modbus_simulator.py --port 5020 &
          sleep 1
          alr exec -- gprbuild -P tests/integration/integration_tests.gpr
          ./bin/integration_test_runner
          pkill -f modbus_simulator.py || true

      - name: Run TLS tests
        run: |
          nohup python3 tests/integration/tls_modbus_server.py \
            --cert tests/integration/certs/server.crt \
            --key tests/integration/certs/server.key --port 8802 &
          sleep 1
          cd tls && alr exec -- gprbuild -P ../tests/integration/tls_integration_tests.gpr -XSOCKET=openssl
          cd .. && ./bin/tls_integration_test_runner
          pkill -f tls_modbus_server.py || true

  spark-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Alire
        uses: alire-project/setup-alire@v3
        with:
          version: ${{ env.ALIRE_VERSION }}
          toolchain: gnat_native^15
          cache: true

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/alire
            obj/gnatprove
          key: spark-${{ runner.os }}-${{ hashFiles('src/**/*.ads', 'src/**/*.adb') }}

      - name: SPARK proof
        run: |
          alr toolchain --select gnat_native^15 gprbuild
          alr update
          alr --force with gnatprove
          alr exec -- gnatprove -P adamodbus.gpr --mode=prove --level=1 -j0 \
            --report=statistics --output=oneline 2>&1 | tee spark.txt
          UNPROVEN=$(grep -oP 'Unproved\s+\K\d+' spark.txt || echo "0")
          [ "$UNPROVEN" -le 5 ] || exit 1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spark-results
          path: spark.txt

  build-embedded:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Alire
        uses: alire-project/setup-alire@v3
        with:
          version: ${{ env.ALIRE_VERSION }}
          toolchain: gnat_arm_elf^15
          cache: true

      - name: Cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/alire
          key: alire-arm-${{ runner.os }}-${{ hashFiles('examples/embedded/**/alire.toml') }}

      - name: Install QEMU
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: qemu-system-arm
          version: 1.0

      - name: Build & test embedded
        run: |
          alr toolchain --select gnat_arm_elf^15 gprbuild

          # Loopback test
          cd examples/embedded/cortex_m4_lwip && alr build
          timeout 10 qemu-system-arm -M lm3s6965evb -nographic -semihosting \
            -kernel bin/main_loopback.elf || true
          cd ../../..

          # RTU test
          cd examples/embedded/stm32_rtu && alr build
          alr exec -- gprbuild -P stm32_rtu.gpr -XMAIN=slave
          alr exec -- gprbuild -P stm32_rtu.gpr -XMAIN=master
          chmod +x run_ci_test.sh && ./run_ci_test.sh
          cd ../../..

          # TLS loopback test
          cd examples/embedded/cortex_m4_tls
          alr exec -- gprbuild -P cortex_m4_tls.gpr -XMBEDTLS_MODE=loopback
          timeout 10 qemu-system-arm -M lm3s6965evb -nographic -semihosting \
            -kernel bin/main_loopback_tls.elf 2>&1 | tee qemu.txt || true
          grep -q "LOOPBACK TEST PASSED" qemu.txt
